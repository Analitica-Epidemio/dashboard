.PHONY: help setup install dev dev-docker dev-docker-down test lint format typecheck qa clean

# =============================================================================
# COMANDOS PRINCIPALES
# =============================================================================

help:  ## ðŸ“š Muestra esta ayuda
	@echo "Sistema de EpidemiologÃ­a - Comandos disponibles"
	@echo "================================================"
	@echo ""
	@echo "INICIO RÃPIDO:"
	@echo "  make setup        â†’ ConfiguraciÃ³n inicial del proyecto (primera vez)"
	@echo "  make dev-docker   â†’ Desarrollo CON Docker (incluye DB + Redis)"
	@echo "  make dev          â†’ Desarrollo SIN Docker (requiere DB local)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# =============================================================================
# CONFIGURACIÃ“N INICIAL
# =============================================================================

setup:  ## ðŸŽ¯ ConfiguraciÃ³n inicial completa (ejecutar la primera vez)
	@echo "ðŸš€ Configurando proyecto por primera vez..."
	@echo "1. Verificando archivo .env..."
	@if [ ! -f .env ]; then \
		if [ -f .env.example ]; then \
			cp .env.example .env; \
			echo "âœ… Archivo .env creado desde .env.example"; \
			echo "âš ï¸  IMPORTANTE: Edita el archivo .env con tus configuraciones"; \
		else \
			echo "âŒ No se encontrÃ³ .env.example"; \
			exit 1; \
		fi \
	else \
		echo "âœ… Archivo .env ya existe"; \
	fi
	@echo "2. Creando directorios necesarios..."
	@mkdir -p uploads logs
	@echo "3. Instalando dependencias con uv..."
	@uv sync --all-extras
	@echo ""
	@echo "âœ… ConfiguraciÃ³n completada!"
	@echo ""
	@echo "ðŸ”¥ PRÃ“XIMOS PASOS:"
	@echo "   1. Edita el archivo .env con tus configuraciones"
	@echo "   2. Elige cÃ³mo ejecutar el proyecto:"
	@echo "      â€¢ CON Docker:    make dev-docker"
	@echo "      â€¢ SIN Docker:    make dev"

install:  ## ðŸ“¦ Instala/actualiza las dependencias
	uv sync --all-extras

# =============================================================================
# DESARROLLO CON DOCKER (Recomendado)
# =============================================================================

dev-docker:  ## ðŸ³ Inicia desarrollo CON Docker (API + DB + Redis con hot-reload)
	@echo "ðŸ³ Iniciando stack de desarrollo con Docker..."
	@echo "   â€¢ PostgreSQL en puerto 5432"
	@echo "   â€¢ Redis en puerto 6379"
	@echo "   â€¢ API en puerto 8000 con hot-reload"
	docker-compose -f docker-compose.dev.yml up

dev-docker-down:  ## ðŸ›‘ Detiene los servicios Docker
	docker-compose -f docker-compose.dev.yml down

dev-docker-rebuild:  ## ðŸ”„ Reconstruye y reinicia servicios Docker
	docker-compose -f docker-compose.dev.yml up --build

dev-docker-logs:  ## ðŸ“‹ Ver logs de los servicios Docker
	docker-compose -f docker-compose.dev.yml logs -f

dev-docker-db-reset:  ## ðŸ’£ Reinicia la BD Docker desde cero (BORRA TODOS LOS DATOS)
	@echo "âš ï¸  ADVERTENCIA: Esto eliminarÃ¡ TODOS los datos de la base de datos"
	@read -p "Â¿EstÃ¡s seguro? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	docker-compose -f docker-compose.dev.yml down
	docker volume rm epi_dashboard_postgres_data_dev 2>/dev/null || true
	@echo "âœ… Base de datos eliminada. Se crearÃ¡ una nueva al ejecutar 'make dev-docker'"

# =============================================================================
# DESARROLLO SIN DOCKER (Requiere PostgreSQL y Redis locales)
# =============================================================================

dev:  ## ðŸ’» Inicia desarrollo SIN Docker (requiere DB y Redis locales)
	@echo "ðŸ’» Iniciando servidor de desarrollo local..."
	@echo "   âš ï¸  Requiere PostgreSQL y Redis instalados localmente"
	uv run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# =============================================================================
# TESTING Y CALIDAD DE CÃ“DIGO
# =============================================================================

test:  ## ðŸ§ª Ejecuta los tests
	uv run pytest

test-watch:  ## ðŸ‘€ Ejecuta los tests en modo watch
	uv run pytest-watch

test-coverage:  ## ðŸ“Š Ejecuta tests con reporte de cobertura
	uv run pytest --cov=app --cov-report=html --cov-report=term

lint:  ## ðŸ” Ejecuta el linter y arregla problemas
	uv run ruff check . --fix

format:  ## ðŸ’… Formatea el cÃ³digo
	uv run ruff format .

typecheck:  ## ðŸ”Ž Verifica tipos con mypy
	uv run mypy app

qa:  ## âœ… Ejecuta todos los checks de calidad
	@echo "ðŸ” Ejecutando checks de calidad..."
	@make lint
	@make format
	@make typecheck
	@make test

# =============================================================================
# BASE DE DATOS
# =============================================================================

migrate:  ## ðŸ—„ï¸ Ejecuta las migraciones pendientes
	uv run alembic upgrade head

makemigrations:  ## ðŸ“ Genera nueva migraciÃ³n (uso: make makemigrations m="descripciÃ³n")
	uv run alembic revision --autogenerate -m "$(m)"

rollback:  ## â†©ï¸ Rollback de la Ãºltima migraciÃ³n
	uv run alembic downgrade -1

db-history:  ## ðŸ“œ Ver historial de migraciones
	uv run alembic history

# =============================================================================
# PRODUCCIÃ“N
# =============================================================================

docker-prod:  ## ðŸš¢ Construye y ejecuta para producciÃ³n
	docker-compose up --build

docker-build:  ## ðŸ—ï¸ Construye la imagen Docker de producciÃ³n
	docker build -t epidemiologia-api .

# =============================================================================
# UTILIDADES
# =============================================================================

clean:  ## ðŸ§¹ Limpia archivos temporales
	find . -type d -name "__pycache__" -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type f -name "*.coverage" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	find . -type d -name ".pytest_cache" -exec rm -rf {} +
	find . -type d -name ".mypy_cache" -exec rm -rf {} +
	find . -type d -name "htmlcov" -exec rm -rf {} +

pre-commit:  ## ðŸª Instala los hooks de pre-commit
	uv run pre-commit install

pre-commit-run:  ## ðŸ”„ Ejecuta pre-commit en todos los archivos
	uv run pre-commit run --all-files

shell:  ## ðŸš Abre shell de Python con el contexto del proyecto
	uv run python

logs:  ## ðŸ“œ Ver logs de la aplicaciÃ³n
	tail -f logs/*.log 2>/dev/null || echo "No hay logs disponibles"